-- =====================================================
-- Миграция 003: Умный поиск с синонимами и триграммами
-- =====================================================
-- Описание: Добавляет семантический поиск без ML-моделей
-- Дата: 2026-01-29
-- Автор: ITPI Team
-- =====================================================

-- 1. Включаем расширение для триграмм (поиск с опечатками)
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- 2. Создаём таблицу синонимов для семантического поиска
CREATE TABLE IF NOT EXISTS work_synonyms (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  main_term text NOT NULL,                    -- Основной термин
  synonyms text[] NOT NULL,                   -- Массив синонимов
  category text NOT NULL,                     -- Категория: 'геодезия', 'геология', 'общее'
  description text,                           -- Описание термина
  source_ref text,                            -- Ссылка на источник (СБЦ ИГДИ 2004)
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  
  -- Полнотекстовый поиск по синонимам (обычная колонка, обновляется триггером)
  search_vector tsvector
);

-- 3. Создаём функцию для обновления search_vector
CREATE OR REPLACE FUNCTION update_work_synonyms_search_vector()
RETURNS TRIGGER AS $$
BEGIN
  NEW.search_vector := to_tsvector('russian', 
    NEW.main_term || ' ' || 
    array_to_string(NEW.synonyms, ' ') || ' ' || 
    COALESCE(NEW.description, '')
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- 4. Создаём триггер для автоматического обновления search_vector
CREATE TRIGGER work_synonyms_search_vector_update
  BEFORE INSERT OR UPDATE ON work_synonyms
  FOR EACH ROW
  EXECUTE FUNCTION update_work_synonyms_search_vector();

-- 5. Создаём индексы для быстрого поиска
CREATE INDEX IF NOT EXISTS work_synonyms_main_term_idx ON work_synonyms(main_term);
CREATE INDEX IF NOT EXISTS work_synonyms_category_idx ON work_synonyms(category);
CREATE INDEX IF NOT EXISTS work_synonyms_search_vector_idx ON work_synonyms USING gin(search_vector);
CREATE INDEX IF NOT EXISTS work_synonyms_main_term_trgm_idx ON work_synonyms USING gin(main_term gin_trgm_ops);

-- Триграммный индекс для norm_items (поиск с опечатками)
CREATE INDEX IF NOT EXISTS norm_items_work_title_trgm_idx ON norm_items USING gin(work_title gin_trgm_ops);

-- 6. Заполняем синонимы из СБЦ ИГДИ 2004
-- =====================================================
-- КАТЕГОРИЯ: ГЕОДЕЗИЯ
-- =====================================================

INSERT INTO work_synonyms (main_term, synonyms, category, description, source_ref) VALUES
  -- Топографические съёмки
  ('топографическая съёмка', 
   ARRAY['геодезическая съёмка', 'инженерная съёмка', 'тахеометрическая съёмка', 'топосъёмка', 'топография'],
   'геодезия',
   'Создание инженерно-топографических планов местности',
   'СБЦ ИГДИ 2004, Часть 1, Глава 2'),
   
  ('нивелирование', 
   ARRAY['высотная съёмка', 'определение высот', 'геометрическое нивелирование', 'техническое нивелирование', 'измерение превышений'],
   'геодезия',
   'Определение разности высот точек земной поверхности',
   'СБЦ ИГДИ 2004, Таблица 8'),
   
  ('опорная геодезическая сеть', 
   ARRAY['геодезическая сеть', 'планово-высотная сеть', 'съёмочная сеть', 'сеть сгущения', 'триангуляция'],
   'геодезия',
   'Система закреплённых точек с известными координатами',
   'СБЦ ИГДИ 2004, Глава 1'),
   
  ('координирование', 
   ARRAY['определение координат', 'плановая привязка', 'геодезическая привязка', 'координатная привязка'],
   'геодезия',
   'Определение плановых координат точек',
   'СБЦ ИГДИ 2004, Таблица 48'),
   
  ('разбивка пикетажа', 
   ARRAY['пикетаж', 'разбивка пикетов', 'закрепление пикетов', 'пикетирование'],
   'геодезия',
   'Разметка и закрепление точек через определённые интервалы',
   'СБЦ ИГДИ 2004, Глава 3'),
   
  ('трассирование', 
   ARRAY['вынос трассы', 'разбивка трассы', 'камеральное трассирование', 'полевое трассирование'],
   'геодезия',
   'Определение положения оси линейного сооружения',
   'СБЦ ИГДИ 2004, Глава 3'),
   
  ('съёмка пересечений', 
   ARRAY['съёмка переходов', 'съёмка узлов', 'съёмка коммуникаций'],
   'геодезия',
   'Топографическая съёмка мест пересечения с существующими сооружениями',
   'СБЦ ИГДИ 2004, Таблица 34-35'),
   
  ('закрепление точек', 
   ARRAY['установка знаков', 'закладка центров', 'закладка реперов', 'установка геодезических знаков'],
   'геодезия',
   'Установка постоянных или временных геодезических знаков',
   'СБЦ ИГДИ 2004, Таблица 46'),
   
  ('теодолитный ход', 
   ARRAY['полигонометрия', 'теодолитная съёмка', 'угловые измерения'],
   'геодезия',
   'Метод создания планового обоснования',
   'СБЦ ИГДИ 2004, Таблица 47'),
   
  ('нивелирный ход', 
   ARRAY['высотный ход', 'нивелирование по пикетам', 'высотная привязка'],
   'геодезия',
   'Метод создания высотного обоснования',
   'СБЦ ИГДИ 2004, Таблица 47'),

-- =====================================================
-- КАТЕГОРИЯ: ГЕОЛОГИЯ
-- =====================================================

  ('бурение скважин', 
   ARRAY['проходка скважин', 'буровые работы', 'колонковое бурение', 'вращательное бурение', 'бурение'],
   'геология',
   'Проходка вертикальных или наклонных горных выработок',
   'СБЦ ИГИ 1999, Таблица 17'),
   
  ('отбор проб', 
   ARRAY['опробование', 'отбор образцов', 'пробоотбор', 'отбор монолитов', 'керновое опробование'],
   'геология',
   'Извлечение образцов грунта для лабораторных исследований',
   'СБЦ ИГИ 1999, Таблица 57-60'),
   
  ('лабораторные исследования', 
   ARRAY['лабораторные испытания', 'лабораторные анализы', 'физико-механические свойства', 'определение свойств грунтов'],
   'геология',
   'Определение физических и механических характеристик грунтов',
   'СБЦ ИГИ 1999, Таблица 63-73'),
   
  ('статическое зондирование', 
   ARRAY['зондирование', 'CPT', 'пенетрация', 'статические испытания'],
   'геология',
   'Метод определения свойств грунтов путём вдавливания зонда',
   'СБЦ ИГИ 1999, Таблица 45'),
   
  ('динамическое зондирование', 
   ARRAY['ударное зондирование', 'DPT', 'динамические испытания'],
   'геология',
   'Метод определения свойств грунтов путём забивки зонда',
   'СБЦ ИГИ 1999, Таблица 46'),
   
  ('штамповые испытания', 
   ARRAY['испытания штампом', 'определение модуля деформации', 'полевые испытания грунтов'],
   'геология',
   'Определение деформационных характеристик грунтов в полевых условиях',
   'СБЦ ИГИ 1999, Таблица 54'),
   
  ('гидрогеологические наблюдения', 
   ARRAY['наблюдения за уровнем воды', 'замер уровня', 'опытные откачки', 'гидрогеология'],
   'геология',
   'Изучение подземных вод и их режима',
   'СБЦ ИГИ 1999, Таблица 18'),
   
  ('инженерно-геологическая рекогносцировка', 
   ARRAY['геологическая рекогносцировка', 'маршрутные наблюдения', 'рекогносцировочное обследование'],
   'геология',
   'Предварительное изучение геологических условий',
   'СБЦ ИГИ 1999, Таблица 9-11'),

-- =====================================================
-- КАТЕГОРИЯ: ОБЩИЕ ТЕРМИНЫ
-- =====================================================

  ('инженерные изыскания', 
   ARRAY['изыскания', 'инженерно-геодезические изыскания', 'ИГДИ', 'инженерно-геологические изыскания', 'ИГИ', 'изыскательские работы'],
   'общее',
   'Комплекс работ по изучению природных условий территории',
   'СБЦ ИГДИ 2004, Общие указания'),
   
  ('обследование', 
   ARRAY['рекогносцировка', 'осмотр', 'инспекция', 'визуальное обследование', 'техническое обследование'],
   'общее',
   'Изучение состояния объекта или территории',
   'СБЦ ИГДИ 2004'),
   
  ('камеральные работы', 
   ARRAY['камеральная обработка', 'обработка материалов', 'составление отчёта', 'вычисления'],
   'общее',
   'Работы по обработке полевых материалов в офисе',
   'СБЦ ИГДИ 2004, Общие указания'),
   
  ('полевые работы', 
   ARRAY['полевые изыскания', 'работы на местности', 'натурные работы', 'экспедиционные работы'],
   'общее',
   'Работы, выполняемые непосредственно на объекте',
   'СБЦ ИГДИ 2004, Общие указания'),
   
  ('составление программы', 
   ARRAY['программа работ', 'техническое задание', 'программа изысканий'],
   'общее',
   'Разработка плана выполнения изыскательских работ',
   'СБЦ ИГДИ 2004, Таблица 78'),
   
  ('технический отчёт', 
   ARRAY['отчёт', 'отчётные материалы', 'технический отчёт по изысканиям', 'заключение'],
   'общее',
   'Документ с результатами выполненных работ',
   'СБЦ ИГДИ 2004, Таблица 79'),
   
  ('привязка', 
   ARRAY['геодезическая привязка', 'плановая привязка', 'высотная привязка', 'координатная привязка'],
   'общее',
   'Определение положения точек относительно опорной сети',
   'СБЦ ИГДИ 2004, Таблица 48'),
   
  ('съёмка', 
   ARRAY['топографическая съёмка', 'геодезическая съёмка', 'инструментальная съёмка'],
   'общее',
   'Измерения для создания планов и карт',
   'СБЦ ИГДИ 2004'),

-- =====================================================
-- КАТЕГОРИЯ: МАСШТАБЫ И ТОЧНОСТЬ
-- =====================================================

  ('масштаб 1:500', 
   ARRAY['М 1:500', 'масштаб 1 к 500', 'крупный масштаб', 'детальная съёмка'],
   'масштаб',
   'Масштаб топографической съёмки для детального проектирования',
   'СБЦ ИГДИ 2004, Таблица 9'),
   
  ('масштаб 1:1000', 
   ARRAY['М 1:1000', 'масштаб 1 к 1000'],
   'масштаб',
   'Масштаб топографической съёмки',
   'СБЦ ИГДИ 2004, Таблица 9'),
   
  ('масштаб 1:2000', 
   ARRAY['М 1:2000', 'масштаб 1 к 2000'],
   'масштаб',
   'Масштаб топографической съёмки',
   'СБЦ ИГДИ 2004, Таблица 9'),
   
  ('масштаб 1:5000', 
   ARRAY['М 1:5000', 'масштаб 1 к 5000'],
   'масштаб',
   'Масштаб топографической съёмки для общего проектирования',
   'СБЦ ИГДИ 2004, Таблица 9'),
   
  ('высота сечения рельефа', 
   ARRAY['сечение рельефа', 'высота сечения', 'интервал горизонталей'],
   'масштаб',
   'Расстояние по высоте между соседними горизонталями',
   'СБЦ ИГДИ 2004, Таблица 9'),

-- =====================================================
-- КАТЕГОРИЯ: ЛИНЕЙНЫЕ СООРУЖЕНИЯ
-- =====================================================

  ('трасса', 
   ARRAY['ось трассы', 'линейное сооружение', 'трассирование линейных сооружений'],
   'линейные',
   'Ось проектируемого линейного сооружения',
   'СБЦ ИГДИ 2004, Глава 3'),
   
  ('железная дорога', 
   ARRAY['ж/д', 'железнодорожная линия', 'рельсовый путь'],
   'линейные',
   'Линейное сооружение для движения поездов',
   'СБЦ ИГДИ 2004, Таблица 12'),
   
  ('автомобильная дорога', 
   ARRAY['автодорога', 'шоссе', 'дорога', 'проезжая часть'],
   'линейные',
   'Линейное сооружение для движения автотранспорта',
   'СБЦ ИГДИ 2004, Таблица 12'),
   
  ('трубопровод', 
   ARRAY['магистральный трубопровод', 'газопровод', 'нефтепровод', 'водопровод'],
   'линейные',
   'Линейное сооружение для транспортировки жидкостей и газов',
   'СБЦ ИГДИ 2004, Таблица 13'),
   
  ('линия электропередачи', 
   ARRAY['ЛЭП', 'ВЛ', 'воздушная линия', 'кабельная линия', 'электросеть'],
   'линейные',
   'Линейное сооружение для передачи электроэнергии',
   'СБЦ ИГДИ 2004, Таблица 15'),
   
  ('канал', 
   ARRAY['оросительный канал', 'магистральный канал', 'коллектор'],
   'линейные',
   'Искусственное русло для транспортировки воды',
   'СБЦ ИГДИ 2004, Таблица 16'),

-- =====================================================
-- КАТЕГОРИЯ: ТЕРРИТОРИИ
-- =====================================================

  ('застроенная территория', 
   ARRAY['городская территория', 'населённый пункт', 'застройка', 'городская застройка'],
   'территория',
   'Территория с существующими зданиями и сооружениями',
   'СБЦ ИГДИ 2004, Глава 2'),
   
  ('незастроенная территория', 
   ARRAY['свободная территория', 'открытая местность', 'незастроенная местность'],
   'территория',
   'Территория без существующих зданий',
   'СБЦ ИГДИ 2004, Глава 2'),
   
  ('промышленная площадка', 
   ARRAY['промплощадка', 'территория предприятия', 'действующее предприятие', 'производственная территория'],
   'территория',
   'Территория промышленного предприятия',
   'СБЦ ИГДИ 2004, Таблица 9'),
   
  ('строительная площадка', 
   ARRAY['стройплощадка', 'площадка строительства', 'участок строительства'],
   'территория',
   'Территория для размещения строящихся объектов',
   'СБЦ ИГДИ 2004'),

-- =====================================================
-- КАТЕГОРИЯ: ПОДЗЕМНЫЕ КОММУНИКАЦИИ
-- =====================================================

  ('подземные коммуникации', 
   ARRAY['подземные сети', 'инженерные сети', 'коммуникации', 'подземные сооружения'],
   'коммуникации',
   'Подземные инженерные сети и сооружения',
   'СБЦ ИГДИ 2004, Глава 6'),
   
  ('съёмка коммуникаций', 
   ARRAY['съёмка подземных сетей', 'съёмка инженерных сетей', 'трассировка коммуникаций'],
   'коммуникации',
   'Определение положения подземных коммуникаций',
   'СБЦ ИГДИ 2004, Таблица 37'),
   
  ('обследование колодцев', 
   ARRAY['описание колодцев', 'съёмка колодцев', 'инвентаризация колодцев'],
   'коммуникации',
   'Изучение состояния и содержимого смотровых колодцев',
   'СБЦ ИГДИ 2004, Таблица 43'),
   
  ('трубокабелеискатель', 
   ARRAY['прибор поиска', 'локатор коммуникаций', 'детектор труб'],
   'коммуникации',
   'Прибор для обнаружения подземных коммуникаций',
   'СБЦ ИГДИ 2004, Таблица 40');

-- 7. Создаём функцию семантического поиска
-- =====================================================

CREATE OR REPLACE FUNCTION semantic_search_norm_items(
  search_query text,
  limit_count int DEFAULT 20
)
RETURNS TABLE (
  id uuid,
  work_title text,
  unit text,
  price numeric,
  table_no int,
  relevance_score float,
  match_type text,
  matched_synonym text
) AS $$
BEGIN
  RETURN QUERY
  WITH synonym_matches AS (
    -- Находим все синонимы для запроса
    SELECT DISTINCT 
      ws.main_term,
      unnest(ws.synonyms || ws.main_term) as term,
      ws.category
    FROM work_synonyms ws
    WHERE 
      -- Прямое совпадение с основным термином
      ws.main_term ILIKE '%' || search_query || '%'
      -- Или совпадение с любым синонимом
      OR EXISTS (
        SELECT 1 FROM unnest(ws.synonyms) s 
        WHERE s ILIKE '%' || search_query || '%'
      )
      -- Или полнотекстовый поиск
      OR ws.search_vector @@ plainto_tsquery('russian', search_query)
      -- Или триграммное сходство
      OR ws.main_term % search_query
  )
  SELECT 
    ni.id,
    ni.work_title,
    ni.unit,
    ni.price,
    ni.table_no,
    (
      -- 1. Прямое точное совпадение (100 баллов)
      CASE WHEN ni.work_title ILIKE '%' || search_query || '%' THEN 100.0
      ELSE 0.0 END
      +
      -- 2. Совпадение с синонимами (80 баллов)
      CASE WHEN EXISTS (
        SELECT 1 FROM synonym_matches sm 
        WHERE ni.work_title ILIKE '%' || sm.term || '%'
      ) THEN 80.0
      ELSE 0.0 END
      +
      -- 3. Полнотекстовый поиск (40 баллов)
      COALESCE(ts_rank(ni.search_text, plainto_tsquery('russian', search_query)) * 40.0, 0.0)
      +
      -- 4. Триграммное сходство для опечаток (20 баллов)
      COALESCE(similarity(ni.work_title, search_query) * 20.0, 0.0)
      +
      -- 5. Бонус за совпадение категории (10 баллов)
      CASE WHEN EXISTS (
        SELECT 1 FROM synonym_matches sm 
        WHERE ni.work_title ILIKE '%' || sm.category || '%'
      ) THEN 10.0
      ELSE 0.0 END
    ) as relevance_score,
    -- Тип совпадения
    CASE 
      WHEN ni.work_title ILIKE '%' || search_query || '%' THEN 'exact'
      WHEN EXISTS (
        SELECT 1 FROM synonym_matches sm 
        WHERE ni.work_title ILIKE '%' || sm.term || '%'
      ) THEN 'synonym'
      WHEN ni.search_text @@ plainto_tsquery('russian', search_query) THEN 'fulltext'
      WHEN ni.work_title % search_query THEN 'fuzzy'
      ELSE 'other'
    END as match_type,
    -- Какой синоним сработал
    COALESCE(
      (SELECT sm.term FROM synonym_matches sm 
       WHERE ni.work_title ILIKE '%' || sm.term || '%' 
       LIMIT 1),
      search_query
    ) as matched_synonym
  FROM norm_items ni
  WHERE 
    -- Прямое совпадение
    ni.work_title ILIKE '%' || search_query || '%'
    -- Или полнотекстовый поиск
    OR ni.search_text @@ plainto_tsquery('russian', search_query)
    -- Или триграммное сходство (для опечаток)
    OR ni.work_title % search_query
    -- Или совпадение с синонимами
    OR EXISTS (
      SELECT 1 FROM synonym_matches sm 
      WHERE ni.work_title ILIKE '%' || sm.term || '%'
    )
  ORDER BY relevance_score DESC
  LIMIT limit_count;
END;
$$ LANGUAGE plpgsql;

-- 8. Создаём вспомогательную функцию для поиска синонимов
-- =====================================================

CREATE OR REPLACE FUNCTION find_synonyms(search_term text)
RETURNS TABLE (
  main_term text,
  synonyms text[],
  category text,
  description text
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    ws.main_term,
    ws.synonyms,
    ws.category,
    ws.description
  FROM work_synonyms ws
  WHERE 
    ws.main_term ILIKE '%' || search_term || '%'
    OR EXISTS (
      SELECT 1 FROM unnest(ws.synonyms) s 
      WHERE s ILIKE '%' || search_term || '%'
    )
    OR ws.search_vector @@ plainto_tsquery('russian', search_term)
  ORDER BY 
    CASE 
      WHEN ws.main_term ILIKE search_term THEN 1
      WHEN ws.main_term ILIKE search_term || '%' THEN 2
      WHEN ws.main_term ILIKE '%' || search_term || '%' THEN 3
      ELSE 4
    END;
END;
$$ LANGUAGE plpgsql;

-- 9. Комментарии к таблицам и функциям
-- =====================================================

COMMENT ON TABLE work_synonyms IS 'Словарь синонимов для семантического поиска работ';
COMMENT ON COLUMN work_synonyms.main_term IS 'Основной термин (каноническое название)';
COMMENT ON COLUMN work_synonyms.synonyms IS 'Массив синонимов и альтернативных названий';
COMMENT ON COLUMN work_synonyms.category IS 'Категория: геодезия, геология, общее, масштаб, линейные, территория, коммуникации';
COMMENT ON COLUMN work_synonyms.description IS 'Описание термина для понимания контекста';
COMMENT ON COLUMN work_synonyms.source_ref IS 'Ссылка на источник (СБЦ ИГДИ 2004, таблица/глава)';

COMMENT ON FUNCTION semantic_search_norm_items IS 'Умный поиск работ с учётом синонимов, опечаток и полнотекстового поиска';
COMMENT ON FUNCTION find_synonyms IS 'Поиск синонимов для заданного термина';

-- =====================================================
-- Миграция 003 завершена успешно!
-- =====================================================
-- Добавлено:
-- - Расширение pg_trgm для поиска с опечатками
-- - Таблица work_synonyms с 40+ терминами из СБЦ ИГДИ 2004
-- - Триггер для автоматического обновления search_vector
-- - Функция semantic_search_norm_items() для умного поиска
-- - Функция find_synonyms() для поиска синонимов
-- - Индексы для быстрого поиска
-- =====================================================
