-- =====================================================
-- Миграция 010: Расширенные синонимы для поиска
-- =====================================================
-- Описание: Создание таблицы синонимов и добавление вариантов написания
--           для улучшения качества поиска расценок
-- Дата: 2026-01-29
-- =====================================================

-- ========================================
-- СОЗДАНИЕ ТАБЛИЦЫ СИНОНИМОВ
-- ========================================

-- Создаем таблицу для хранения синонимов и вариантов написания
CREATE TABLE IF NOT EXISTS search_synonyms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    term TEXT NOT NULL UNIQUE,
    synonyms TEXT[] NOT NULL,
    category TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Комментарии к таблице
COMMENT ON TABLE search_synonyms IS 'Синонимы и варианты написания для улучшения поиска';
COMMENT ON COLUMN search_synonyms.term IS 'Основной термин';
COMMENT ON COLUMN search_synonyms.synonyms IS 'Массив синонимов и вариантов написания';
COMMENT ON COLUMN search_synonyms.category IS 'Категория термина (scale, relief, category, territory, linear, etc.)';

-- ========================================
-- ДОБАВЛЕНИЕ СИНОНИМОВ
-- ========================================

INSERT INTO search_synonyms (term, synonyms, category) VALUES
-- Масштабы (различные варианты написания)
('масштаб 1:500', ARRAY['м 1:500', 'М1:500', 'масштаб 1/500', 'м-б 1:500', 'мб 1:500', '1:500', 'пятьсот'], 'scale'),
('масштаб 1:1000', ARRAY['м 1:1000', 'М1:1000', 'масштаб 1/1000', 'м-б 1:1000', 'мб 1:1000', '1:1000', 'тысяча'], 'scale'),
('масштаб 1:2000', ARRAY['м 1:2000', 'М1:2000', 'масштаб 1/2000', 'м-б 1:2000', 'мб 1:2000', '1:2000', 'двухтысячный'], 'scale'),
('масштаб 1:5000', ARRAY['м 1:5000', 'М1:5000', 'масштаб 1/5000', 'м-б 1:5000', 'мб 1:5000', '1:5000', 'пятитысячный'], 'scale'),
('масштаб 1:10000', ARRAY['м 1:10000', 'М1:10000', 'масштаб 1/10000', 'м-б 1:10000', 'мб 1:10000', '1:10000', 'десятитысячный'], 'scale'),

-- Высота сечения рельефа
('сечение 0,25', ARRAY['сечение 0.25', 'сечение 0,25м', 'сечение 0.25м', 'высота сечения 0,25', 'h=0,25', '0,25м'], 'relief'),
('сечение 0,5', ARRAY['сечение 0.5', 'сечение 0,5м', 'сечение 0.5м', 'высота сечения 0,5', 'h=0,5', '0,5м'], 'relief'),
('сечение 1', ARRAY['сечение 1м', 'сечение 1.0', 'высота сечения 1', 'h=1', '1м'], 'relief'),
('сечение 2', ARRAY['сечение 2м', 'сечение 2.0', 'высота сечения 2', 'h=2', '2м'], 'relief'),
('сечение 5', ARRAY['сечение 5м', 'сечение 5.0', 'высота сечения 5', 'h=5', '5м'], 'relief'),

-- Категории сложности
('I категория', ARRAY['1 категория', 'первая категория', 'кат I', 'кат. I', 'категория 1', 'простая', 'легкая'], 'category'),
('II категория', ARRAY['2 категория', 'вторая категория', 'кат II', 'кат. II', 'категория 2', 'средняя'], 'category'),
('III категория', ARRAY['3 категория', 'третья категория', 'кат III', 'кат. III', 'категория 3', 'сложная', 'трудная'], 'category'),

-- Типы территорий
('незастроенная', ARRAY['незастроенная территория', 'открытая местность', 'свободная территория', 'открытая'], 'territory'),
('застроенная', ARRAY['застроенная территория', 'городская территория', 'населенный пункт', 'город'], 'territory'),
('промпредприятие', ARRAY['промышленное предприятие', 'действующее предприятие', 'завод', 'фабрика', 'производство', 'промышленная'], 'territory'),

-- Линейные сооружения - дороги
('железная дорога', ARRAY['ж/д', 'жд', 'железнодорожная трасса', 'рельсовый путь', 'рельсы'], 'linear'),
('автомобильная дорога', ARRAY['автодорога', 'а/д', 'ад', 'шоссе', 'трасса'], 'linear'),
('I-II категория дороги', ARRAY['1-2 категория', 'первая-вторая категория', 'высшая категория'], 'road_category'),
('III-IV категория дороги', ARRAY['3-4 категория', 'третья-четвертая категория', 'средняя категория'], 'road_category'),
('V категория дороги', ARRAY['5 категория', 'пятая категория', 'низшая категория'], 'road_category'),

-- Линейные сооружения - трубопроводы
('трубопровод', ARRAY['магистральный трубопровод', 'труба', 'газопровод', 'нефтепровод', 'водопровод'], 'linear'),

-- Линейные сооружения - ЛЭП
('линия электропередачи', ARRAY['ЛЭП', 'лэп', 'электролиния', 'воздушная линия', 'ВЛ', 'электропередача'], 'linear'),
('0,4-20 кВ', ARRAY['0.4-20 кВ', 'до 20 кВ', 'низкое напряжение', '20кВ'], 'voltage'),
('35-110 кВ', ARRAY['35-110кВ', 'среднее напряжение', '110кВ'], 'voltage'),
('220-500 кВ', ARRAY['220-500кВ', 'высокое напряжение', '500кВ'], 'voltage'),
('750-1150 кВ', ARRAY['750-1150кВ', 'сверхвысокое напряжение', '1150кВ'], 'voltage'),

-- Опорные сети
('плановая сеть', ARRAY['планово-высотная сеть', 'геодезическая сеть', 'опорная сеть', 'триангуляция', 'полигонометрия'], 'geodetic'),
('4 класс', ARRAY['четвертый класс', 'IV класс', 'класс 4'], 'geodetic_class'),
('1 разряд', ARRAY['первый разряд', 'I разряд', 'разряд 1'], 'geodetic_class'),
('2 разряд', ARRAY['второй разряд', 'II разряд', 'разряд 2'], 'geodetic_class'),

-- Типы работ
('топографический план', ARRAY['топосъемка', 'топография', 'геодезия', 'план', 'карта', 'съемка'], 'work_type'),
('изыскания', ARRAY['трассирование', 'проектирование', 'обследование'], 'work_type'),

-- Транспорт
('внутренний транспорт', ARRAY['внутритранспорт', 'транспорт на участке', 'местный транспорт'], 'transport'),
('внешний транспорт', ARRAY['дальний транспорт', 'транспорт до объекта', 'доставка'], 'transport'),

-- Коэффициенты
('спецрежим', ARRAY['специальный режим', 'режимная территория', 'охраняемая зона'], 'coefficient'),
('горный район', ARRAY['горы', 'высокогорье', 'горная местность'], 'coefficient'),
('районный коэффициент', ARRAY['районный к-т', 'рк', 'территориальный коэффициент'], 'coefficient'),
('крайний север', ARRAY['север', 'северные районы', 'заполярье'], 'coefficient'),

-- Единицы измерения
('га', ARRAY['гектар', 'гектары'], 'unit'),
('км', ARRAY['километр', 'километры'], 'unit'),
('пункт', ARRAY['пункты', 'точка', 'точки'], 'unit'),

-- Дополнительные работы
('организация работ', ARRAY['орг работ', 'организация и ликвидация', 'орг.ликвидация'], 'additional'),
('неблагоприятный период', ARRAY['зимний период', 'зима', 'неблагоприятные условия'], 'additional')

ON CONFLICT (term) DO UPDATE SET
    synonyms = EXCLUDED.synonyms,
    category = EXCLUDED.category,
    updated_at = CURRENT_TIMESTAMP;

-- ========================================
-- ОБНОВЛЕНИЕ ПОИСКОВЫХ ВЕКТОРОВ
-- ========================================

-- Обновляем поисковые векторы для всех расценок с учетом синонимов
UPDATE norm_items 
SET search_text = to_tsvector('russian', 
    COALESCE(work_title, '') || ' ' ||
    COALESCE(unit, '') || ' ' ||
    COALESCE(params->>'scale', '') || ' ' ||
    COALESCE(params->>'category', '') || ' ' ||
    COALESCE(params->>'territory', '') || ' ' ||
    COALESCE(params->>'road_cat', '') || ' ' ||
    COALESCE(params->>'voltage', '') || ' ' ||
    COALESCE(params->>'line_type', '')
);

-- ========================================
-- СОЗДАНИЕ ИНДЕКСОВ
-- ========================================

-- Индексы для быстрого поиска по категориям синонимов
CREATE INDEX IF NOT EXISTS idx_search_synonyms_category ON search_synonyms(category);
CREATE INDEX IF NOT EXISTS idx_search_synonyms_term_gin ON search_synonyms USING gin(to_tsvector('russian', term));

-- ========================================
-- СТАТИСТИКА
-- ========================================

DO $$
DECLARE
    synonym_count INTEGER;
    norm_items_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO synonym_count FROM search_synonyms;
    SELECT COUNT(*) INTO norm_items_count FROM norm_items;
    
    RAISE NOTICE '=== МИГРАЦИЯ 010 ЗАВЕРШЕНА ===';
    RAISE NOTICE 'Всего синонимов в базе: %', synonym_count;
    RAISE NOTICE 'Всего расценок с обновленным поиском: %', norm_items_count;
    RAISE NOTICE '';
    RAISE NOTICE 'Примеры поиска:';
    RAISE NOTICE '  - SELECT * FROM smart_search_norms(''топосъемка м 1:500'', 5);';
    RAISE NOTICE '  - SELECT * FROM smart_search_norms(''жд трасса 2 категория'', 5);';
    RAISE NOTICE '  - SELECT * FROM smart_search_norms(''лэп 110 кВ'', 5);';
END $$;
