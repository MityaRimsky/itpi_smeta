"""
AI-–∞–≥–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ OpenRouter
"""

from typing import Dict, List, Optional, Tuple
from openai import AsyncOpenAI
from loguru import logger
import json


class AIAgent:
    """AI-–∞–≥–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ OpenRouter"""
    
    def __init__(self, api_key: str, model: str):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI-–∞–≥–µ–Ω—Ç–∞
        
        Args:
            api_key: API –∫–ª—é—á OpenRouter
            model: –ú–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        """
        self.client = AsyncOpenAI(
            api_key=api_key,
            base_url="https://openrouter.ai/api/v1"
        )
        self.model = model
        logger.info(f"AI-–∞–≥–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: {model}")
    
    async def extract_parameters(self, user_message: str) -> Dict:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–±–æ—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        """
        prompt = f"""–ò–∑–≤–ª–µ–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∏—Ö/—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–∞—Ö.

–ó–∞–ø—Ä–æ—Å: "{user_message}"

–í–µ—Ä–Ω–∏ JSON —Å –ø–æ–ª—è–º–∏:
- work_type: —Ç–∏–ø —Ä–∞–±–æ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π –°–¢–ê–ù–î–ê–†–¢–ù–´–ï —Ç–µ—Ä–º–∏–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ:
  * "—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—ä–µ–º–∫–∞" - –¥–ª—è –ª—é–±—ã—Ö —Ç–æ–ø–æ–ø–ª–∞–Ω–æ–≤, –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞–Ω–æ–≤, —Ç–æ–ø–æ—Å—ä–µ–º–∫–∏
  * "–Ω–∏–≤–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ" - –¥–ª—è –≤—ã—Å–æ—Ç–Ω—ã—Ö —Ä–∞–±–æ—Ç
  * "—Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ" - –¥–ª—è –∏–∑—ã—Å–∫–∞–Ω–∏–π —Ç—Ä–∞—Å—Å
  * "–∏–∑—ã—Å–∫–∞–Ω–∏—è —Ç—Ä–∞—Å—Å" - –¥–ª—è –∂/–¥, –∞–≤—Ç–æ–¥–æ—Ä–æ–≥, –õ–≠–ü
  * "–±—É—Ä–µ–Ω–∏–µ" - –¥–ª—è –±—É—Ä–æ–≤—ã—Ö —Ä–∞–±–æ—Ç
  * "–æ–ø–æ—Ä–Ω–∞—è —Å–µ—Ç—å" - –¥–ª—è –≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ç–µ–π
- quantity: –æ–±—ä–µ–º —Ä–∞–±–æ—Ç (—á–∏—Å–ª–æ) –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
- unit: –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è (–≥–∞, –∫–º, –ø—É–Ω–∫—Ç, –º) –∏–ª–∏ null
- scale: –º–∞—Å—à—Ç–∞–± (1:500, 1:1000, 1:2000 –∏ —Ç.–¥.) –∏–ª–∏ null
- category: –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (I, II, III, IV) –∏–ª–∏ null
- territory_type: —Ç–∏–ø —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ - –æ–¥–Ω–æ –∏–∑: "–∑–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è", "–Ω–µ–∑–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è", "–ø—Ä–æ–º–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ" –∏–ª–∏ null
- work_stage: —ç—Ç–∞–ø —Ä–∞–±–æ—Ç - –æ–¥–Ω–æ –∏–∑: "–ø–æ–ª–µ–≤—ã–µ", "–∫–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ", "–æ–±–µ" –∏–ª–∏ null (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ)
- has_underground_comms: –Ω—É–∂–Ω–∞ –ª–∏ —Å—ä–µ–º–∫–∞ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π (true/false/null)
- has_pole_sketches: –Ω—É–∂–Ω—ã –ª–∏ —ç—Å–∫–∏–∑—ã –æ–ø–æ—Ä –õ–≠–ü/—Å–≤—è–∑–∏ (true/false/null)
- use_computer: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –¥–ª—è –∫–∞–º–µ—Ä–∞–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç (true/false/null)
- height_section: –≤—ã—Å–æ—Ç–∞ —Å–µ—á–µ–Ω–∏—è —Ä–µ–ª—å–µ—Ñ–∞ (0.5, 1.0, 2.0 –º) –∏–ª–∏ null
- update_mode: —Ä–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞–Ω–∞ (true/false/null)

–í–ê–ñ–ù–û: 
1. –î–ª—è work_type –∏—Å–ø–æ–ª—å–∑—É–π –°–¢–ê–ù–î–ê–†–¢–ù–´–ï —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ!
2. "–∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω" = "—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—ä–µ–º–∫–∞"
3. "—Ç–æ–ø–æ–ø–ª–∞–Ω" = "—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—ä–µ–º–∫–∞"
4. –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä —è–≤–Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω - –≤–µ—Ä–Ω–∏ null

–ü—Ä–∏–º–µ—Ä—ã:
- "–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞ –º-–±–∞ 1:500" ‚Üí work_type: "—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—ä–µ–º–∫–∞"
- "—Ç–æ–ø–æ–ø–ª–∞–Ω 92 –≥–∞ –ø—Ä–æ–º–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ" ‚Üí work_type: "—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—ä–µ–º–∫–∞", territory_type: "–ø—Ä–æ–º–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ"
- "–∫–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –ø–æ —Ç–æ–ø–æ–ø–ª–∞–Ω—É" ‚Üí work_type: "—Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—ä–µ–º–∫–∞", work_stage: "–∫–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ"
- "—Å—ä–µ–º–∫–∞ —Å –ø–æ–¥–∑–µ–º–Ω—ã–º–∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º–∏" ‚Üí has_underground_comms: true"""

        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                response_format={"type": "json_object"}
            )
            
            result = json.loads(response.choices[0].message.content)
            logger.info(f"–ò–∑–≤–ª–µ—á–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: {result}")
            return result
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: {e}")
            return {}
    
    def get_missing_parameters(self, params: Dict, work_type: str) -> List[Dict]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            params: –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            work_type: –¢–∏–ø —Ä–∞–±–æ—Ç
            
        Returns:
            –°–ø–∏—Å–æ–∫ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤
        """
        missing = []
        
        # –î–ª—è —Ç–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å—ä–µ–º–∫–∏ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if any(kw in work_type.lower() for kw in ['—Ç–æ–ø–æ', '—Å—ä–µ–º–∫–∞', '–ø–ª–∞–Ω']):
            
            # –¢–∏–ø —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –ö1
            if not params.get('territory_type'):
                missing.append({
                    'param': 'territory_type',
                    'question': '–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏:',
                    'options': [
                        ('1', '–ó–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è', '–∑–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è'),
                        ('2', '–ù–µ–∑–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è', '–Ω–µ–∑–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è'),
                        ('3', '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –ø—Ä–æ–º–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è', '–ø—Ä–æ–º–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ')
                    ]
                })
            
            # –°—ä–µ–º–∫–∞ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ö2
            if params.get('has_underground_comms') is None:
                missing.append({
                    'param': 'has_underground_comms',
                    'question': '–ù—É–∂–Ω–∞ —Å—ä–µ–º–∫–∞ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π?',
                    'options': [
                        ('1', '–î–∞, —Å–æ —Å—ä–µ–º–∫–æ–π –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π', True),
                        ('2', '–ù–µ—Ç, –±–µ–∑ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π', False)
                    ]
                })
            
            # –≠—Ç–∞–ø —Ä–∞–±–æ—Ç - –ø–æ–ª–µ–≤—ã–µ/–∫–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ
            if not params.get('work_stage'):
                missing.append({
                    'param': 'work_stage',
                    'question': '–ö–∞–∫–∏–µ —Ä–∞–±–æ—Ç—ã —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å?',
                    'options': [
                        ('1', '–ü–æ–ª–µ–≤—ã–µ –∏ –∫–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)', '–æ–±–µ'),
                        ('2', '–¢–æ–ª—å–∫–æ –ø–æ–ª–µ–≤—ã–µ —Ä–∞–±–æ—Ç—ã', '–ø–æ–ª–µ–≤—ã–µ'),
                        ('3', '–¢–æ–ª—å–∫–æ –∫–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', '–∫–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ')
                    ]
                })
        
        return missing
    
    def determine_coefficients(self, params: Dict, work_stage: str = 'field') -> Tuple[List[str], Dict]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        
        Args:
            params: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–±–æ—Ç
            work_stage: –≠—Ç–∞–ø —Ä–∞–±–æ—Ç ('field' –∏–ª–∏ 'office')
            
        Returns:
            Tuple[—Å–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤, —Å–ª–æ–≤–∞—Ä—å —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º]
        """
        coefficients = []
        details = {}
        
        territory = params.get('territory_type')
        has_underground = params.get('has_underground_comms')
        has_poles = params.get('has_pole_sketches')
        use_computer = params.get('use_computer', True)  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä
        
        # –ö1 - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (–ø—Ä–∏–º. 4 –∫ —Ç. 9)
        if territory == '–ø—Ä–æ–º–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ':
            coefficients.append('TERRITORY_INDUSTRIAL')
            details['–ö1'] = {'value': 1.75, 'reason': '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –ø—Ä–æ–º–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (–ø—Ä–∏–º. 4)'}
        elif territory == '–∑–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è':
            # –î–ª—è –∑–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –∑–∞—Å—Ç—Ä–æ–π–∫–∏
            coefficients.append('TERRITORY_BUILT_UP')
            details['–ö1'] = {'value': 1.0, 'reason': '–ó–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è'}
        else:
            details['–ö1'] = {'value': 1.0, 'reason': '–ù–µ–∑–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è (–±–∞–∑–æ–≤—ã–π)'}
        
        # –ö2 - –°—ä–µ–º–∫–∞ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π (–ø—Ä–∏–º. 5 –∫ —Ç. 9)
        if has_underground:
            coefficients.append('UNDERGROUND_COMMS')
            details['–ö2'] = {'value': 1.30, 'reason': '–°—ä–µ–º–∫–∞ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π (–ø—Ä–∏–º. 5)'}
        else:
            details['–ö2'] = {'value': 1.0, 'reason': '–ë–µ–∑ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π'}
        
        # –ö3 - –≠—Å–∫–∏–∑—ã –æ–ø–æ—Ä (–ø—Ä–∏–º. 5 –∫ —Ç. 9)
        if has_poles:
            coefficients.append('POLE_SKETCHES')
            details['–ö3'] = {'value': 1.0, 'reason': '–° —ç—Å–∫–∏–∑–∞–º–∏ –æ–ø–æ—Ä (–ø—Ä–∏–º. 5)'}
        else:
            details['–ö3'] = {'value': 1.0, 'reason': '–ë–µ–∑ —ç—Å–∫–∏–∑–æ–≤ –æ–ø–æ—Ä'}
        
        # –ö4 - –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞–º–µ—Ä–∞–ª—å–Ω—ã—Ö, –û–£ 15–≥, 15–¥)
        if work_stage == 'office' and use_computer:
            coefficients.append('COMPUTER_TECH')
            details['–ö4'] = {'value': 1.20, 'reason': '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (–û–£ 15–≥, 15–¥)'}
        
        # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞–Ω)
        if params.get('update_mode'):
            coefficients.append('UPDATE_MODE')
            details['–ö–æ–±–Ω'] = {'value': 0.50, 'reason': '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞–Ω–∞'}
        
        logger.info(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è {work_stage}: {coefficients}")
        return coefficients, details
    
    def determine_addons(self, params: Dict, base_cost: float) -> List[str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫–∏–µ –Ω–∞–¥–±–∞–≤–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å
        
        Args:
            params: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–±–æ—Ç
            base_cost: –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
            
        Returns:
            –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ –Ω–∞–¥–±–∞–≤–æ–∫
        """
        addons = []
        
        # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç
        if base_cost <= 75000:
            addons.append('INTERNAL_TRANSPORT_T4_1_1')  # –¥–æ 75 —Ç—ã—Å - 8.75%
        elif base_cost <= 150000:
            addons.append('INTERNAL_TRANSPORT_T4_1_2')  # –¥–æ 150 —Ç—ã—Å - 7.5%
        elif base_cost <= 300000:
            addons.append('INTERNAL_TRANSPORT_T4_1_3')  # –¥–æ 300 —Ç—ã—Å - 6.25%
        else:
            addons.append('INTERNAL_TRANSPORT_T4_1_4')  # —Å–≤—ã—à–µ 300 —Ç—ã—Å - 5%
        
        return addons
    
    async def select_best_work(self, user_request: str, found_works: List[Dict]) -> Optional[Dict]:
        """
        –í—ã–±–∏—Ä–∞–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Ä–∞–±–æ—Ç—É –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
        
        Args:
            user_request: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            found_works: –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç
            
        Returns:
            –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∏–ª–∏ None
        """
        if not found_works:
            return None
        
        if len(found_works) == 1:
            return found_works[0]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è AI
        works_list = "\n".join([
            f"{i+1}. {w['work_title']} ({w['unit']}, –ø–æ–ª–µ–≤—ã–µ: {w.get('price_field', 0)}, –∫–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ: {w.get('price_office', 0)} —Ä—É–±)"
            for i, w in enumerate(found_works)
        ])
        
        prompt = f"""–í—ã–±–µ—Ä–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Ä–∞–±–æ—Ç—É –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ó–∞–ø—Ä–æ—Å: "{user_request}"

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–±–æ—Ç—ã:
{works_list}

–í–µ—Ä–Ω–∏ JSON —Å –ø–æ–ª–µ–º "index" (–Ω–æ–º–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã, –Ω–∞—á–∏–Ω–∞—è —Å 1)."""

        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                response_format={"type": "json_object"}
            )
            
            result = json.loads(response.choices[0].message.content)
            index = result.get("index", 1) - 1
            
            if 0 <= index < len(found_works):
                return found_works[index]
            return found_works[0]
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—Ç—ã: {e}")
            return found_works[0]
    
    async def format_response(self, calculation: Dict) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞ –≤ –ø–æ–Ω—è—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç
        
        Args:
            calculation: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞
            
        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        """
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        return self._simple_format(calculation)
    
    def _simple_format(self, calc: Dict) -> str:
        """–ü—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ AI"""
        work = calc.get('work', {})
        
        text = f"""üìä *–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç*

*–†–∞–±–æ—Ç–∞:* {work.get('work_title', calc.get('work_title', '–ù–µ —É–∫–∞–∑–∞–Ω–æ'))}
*–û–±—ä–µ–º:* {calc['quantity']} {work.get('unit', calc.get('unit', ''))}
*–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:* {work.get('table_ref', calc.get('justification', ''))}

"""
        
        # –ü–æ–ª–µ–≤—ã–µ —Ä–∞–±–æ—Ç—ã
        if calc.get('field_calculation'):
            fc = calc['field_calculation']
            text += f"""üèï *–ü–û–õ–ï–í–´–ï –†–ê–ë–û–¢–´*
‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: {fc['base_price']:,.2f} —Ä—É–±/{work.get('unit', '')}
‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {fc['base_cost']:,.2f} —Ä—É–±
"""
            if fc.get('coefficients'):
                text += "‚Ä¢ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã:\n"
                for code, info in fc['coefficients'].items():
                    text += f"  - {code}: {info['value']} ({info['reason']})\n"
            text += f"‚Ä¢ *–ò—Ç–æ–≥–æ –ø–æ–ª–µ–≤—ã–µ: {fc['total']:,.2f} —Ä—É–±*\n\n"
        
        # –ö–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã
        if calc.get('office_calculation'):
            oc = calc['office_calculation']
            text += f"""üñ• *–ö–ê–ú–ï–†–ê–õ–¨–ù–´–ï –†–ê–ë–û–¢–´*
‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: {oc['base_price']:,.2f} —Ä—É–±/{work.get('unit', '')}
‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {oc['base_cost']:,.2f} —Ä—É–±
"""
            if oc.get('coefficients'):
                text += "‚Ä¢ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã:\n"
                for code, info in oc['coefficients'].items():
                    text += f"  - {code}: {info['value']} ({info['reason']})\n"
            text += f"‚Ä¢ *–ò—Ç–æ–≥–æ –∫–∞–º–µ—Ä–∞–ª—å–Ω—ã–µ: {oc['total']:,.2f} —Ä—É–±*\n\n"
        
        # –ù–∞–¥–±–∞–≤–∫–∏
        if calc.get('addons_applied'):
            text += "‚ûï *–ù–∞–¥–±–∞–≤–∫–∏:*\n"
            for addon in calc['addons_applied']:
                text += f"‚Ä¢ {addon['name']}: {addon['amount']:,.2f} —Ä—É–±\n"
            text += "\n"
        
        # –ò—Ç–æ–≥–æ
        text += f"""‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ *–ò–¢–û–ì–û: {calc['total_cost']:,.2f} —Ä—É–±*
"""
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω–¥–µ–∫—Å –ø–µ—Ä–µ—Å—á–µ—Ç–∞
        if calc.get('price_index'):
            text += f"""
üìà *–° —É—á–µ—Ç–æ–º –∏–Ω–¥–µ–∫—Å–∞ {calc['price_index']['year']}:*
‚Ä¢ –ò–Ω–¥–µ–∫—Å: {calc['price_index']['value']}
‚Ä¢ *–ò–¢–û–ì–û –≤ —Ç–µ–∫—É—â–∏—Ö —Ü–µ–Ω–∞—Ö: {calc['total_with_index']:,.2f} —Ä—É–±*
"""
        
        return text
    
    def format_clarification_question(self, missing_params: List[Dict]) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        
        Args:
            missing_params: –°–ø–∏—Å–æ–∫ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            
        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
        """
        if not missing_params:
            return ""
        
        param = missing_params[0]  # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ –æ–¥–Ω–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É
        
        text = f"‚ùì *{param['question']}*\n\n"
        
        for num, label, _ in param['options']:
            text += f"{num}Ô∏è‚É£ {label}\n"
        
        text += "\n_–ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–º_"
        
        return text
